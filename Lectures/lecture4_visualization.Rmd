---
title: "Lecture 4: Data Visualization"
author: "BIOF 339"
date: "October 3, 2018"
output: 
  revealjs::revealjs_presentation:
    css: style_reveal.css
    theme: league
    highlight: monochrome
    transition: fade
    center: true
    slide_level: 2
    self_contained: false
    reveal_plugins: ["notes"]
# output: 
#   ioslides_presentation:
#     self_contained: true
#     widescreen: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.width = 4,
                      fig.height = 4,
                      comment = '#  ',
                      cache = T)
```

# Data Visualization in R

## Visualization packages

One of R's strengths is data visualization. 

+ Static graph systems
    + Base R graphics
    + `lattice` (Sarkar, et al) 
    + [`ggplot2`](https://ggplot2.tidyverse.org/) (Wickham)

+ Dynamic graphs
    + [`htmlwidgets`](http://www.htmlwidgets.org/)
    + [`leaflet`](https://rstudio.github.io/leaflet/)
    + [`plotly`](https://plot.ly/r/)
    + Many others

## ggplot2

We're making the decision to use `ggplot2` for my graphics

+ Makes pretty good formatting choices out of the box
+ Works like pipes!!
+ Is declarative (tell it what you want) without getting caught up in minutae
+ Strongly leverages data frames (good practice)
+ Fast enough
+ There are good templates if you want to change the look

# Introduction to ggplot2
## Introduction to ggplot2

If you haven't installed it yet:
```{r, eval=FALSE}
install.packages('ggplot2', 
                 repos="http://watson.nci.nih.gov/cran_mirror/")
```
then
```{r}
library(ggplot2)
```

## Introduction to ggplot2

The `ggplot2` package is a very flexible and (to me) intuitive way of visualizing data.
It is based on the concept of layering elements on a canvas.

You need:

+ A `data.frame` object
+ _Aesthetic mappings_ (aes) to say what data is used for what purpose in the viz
    + x- and y-direction
    + shapes, colors, lines
+ A _geometry object_ (geom) to say what to draw
    + You can "layer" geoms on each other to build plots

## Introduction to ggplot2
```{r, eval=F}
library(ggplot2)
ggplot(mtcars, aes(x = wt, y = mpg)) + geom_point()
```

+ A `data.frame` object: mtcars
+ Aesthetic mapping: 
    x-axis: wt
    y-axis: mpg
+ Geometry:
    + geom_point: draw points

## Introduction to ggplot2
```{r, eval=F}
library(ggplot2)
ggplot(mtcars, aes(x = wt, y = mpg)) + geom_point()+ geom_smooth()
```

+ A `data.frame` object: mtcars
+ Aesthetic mapping: 
    x-axis: wt
    y-axis: mpg
+ Geometry:
    + geom_point: draw points
    + geom_smooth: Add a layer which draws a best-fitting line

## Introduction to ggplot2
We will use the two data sets:

```{r, eval=F}
data_spine <- read.csv('http://www.araastat.com/BIOF339_PracticalR/
                       Lectures/lecture2_data/Dataset_spine.csv', 
                       stringsAsFactors = F)

data_brca <- read.csv('http://www.araastat.com/BIOF339_PracticalR/
                      Lectures/lecture2_data/
                      clinical_data_breast_cancer_modified.csv',
                      stringsAsFactors = F)
```

```{r, echo=F}
data_spine <- read.csv('http://www.araastat.com/BIOF339_PracticalR/Lectures/lecture2_data/Dataset_spine.csv')

data_brca <- read.csv('http://www.araastat.com/BIOF339_PracticalR/Lectures/lecture2_data/clinical_data_breast_cancer_modified.csv')

```

# Plotting one variable

## Histograms
```{r}
ggplot(data_brca, aes(x = Age.at.Initial.Pathologic.Diagnosis)) + 
  geom_histogram()
```

## Histograms
```{r}
ggplot(data_brca, aes(x = Age.at.Initial.Pathologic.Diagnosis)) + 
  geom_histogram(binwidth=4)
```

## Density plot
```{r}
ggplot(data_brca, aes(x = Age.at.Initial.Pathologic.Diagnosis)) + 
  geom_density()
```

## Bar plot
```{r}
ggplot(data_brca, aes(x = Tumor))+geom_bar()
```


# Exercise

## Exercise

Using the `mtcars` dataset in R, create:

1. A histogram of the fuel efficiences (`mpg`) in the data set
2. A bar plot of frequencies of number of cylinders (`cyl`) in the car

## Solution

```{r, fig.size=3}
ggplot(mtcars, aes(x = mpg)) + geom_histogram(binwidth=3)
# ggplot(mtcars) + geom_histogram(aes(x = mpg), binwidth = 3)
```

## Solution

```{r}
ggplot(mtcars, aes(x = factor(cyl))) + geom_bar()
```


# Two continuous variables

## Scatter plots
```{r}
ggplot(data_spine, aes(x = Lumbar.lordosis.angle, y = Sacral.slope)) + 
  geom_point()
```

## Scatter plot with a smooth line
```{r}
ggplot(data_spine, aes(x = Lumbar.lordosis.angle, y = Sacral.slope))+
  geom_point() + 
  geom_smooth()
```

## Scatter plot with a smooth straight line
```{r}
ggplot(data_spine, aes(x = Lumbar.lordosis.angle, y = Sacral.slope)) +
  geom_point()+
  geom_smooth(method='lm')
```

## Line plot (for time series)
```{r, warning=F, message=FALSE}
library(forecast)
d <- data.frame(x = 1:length(gas), y = gas) # Australian monthly gas production
ggplot(d, aes(x, y)) + geom_line()
```

# Exercise

## Exercise

1. Create a scatter plot of sepal length and sepal width from the `iris` dataset, and 
add a smooth line through it

## Solution

```{r}
ggplot(iris, aes(Sepal.Length, Sepal.Width)) + geom_point() + geom_smooth()
```

# Continuous variable with discrete variable

## Boxplots
```{r}
ggplot(data_spine, aes(x = Class.attribute, y = Sacral.slope))+
  geom_boxplot()

# Factor/discrete variable is always x
```

## Violin plots
```{r}
ggplot(data_spine, aes(x = Class.attribute, y = Sacral.slope)) +
  geom_violin()
```

# Exercise

## Exercise

1. Plot a boxplot of petal length by species using the `iris` dataset

## Solution

```{r}
ggplot(iris, aes(x = Species, y = Petal.Length))+geom_boxplot()
```


# Flipping axes

## Vertical bars
```{r}
ggplot(data_brca, aes(x = Tumor))+geom_bar()
```

## Horizontal bars
```{r}
ggplot(data_brca, aes(x = Tumor))+geom_bar()+
  coord_flip()
```

# Resources

## Online resources

+ The ggplot [website](http://docs.ggplot2.org) has many resources to help create visualizations
+ There are a lot of blogs showing many capabilities of ggplot2
+ [StackOverflow](http://www.stackoverflow.org) is the place for Q & A. 

## Other packages

+ The [`cowplot`](http://cran.rstudio.com/package=cowplot) package provides several improvements on ggplot2, including more themes and an easy way to put several graphs together in a panel


# Group-wise descriptives and visualizations

## Grouping

+ It is common to look at statistics within subgroups of the data
+ The idea is to see if secondary variables affect your primary outcome or relationship

## Introducing the `dplyr` package

`dplyr` is the most lucid package for manipulating and analyzing data organized in a data frame.

+ It has a `group_by` function which creates a _grouped data frame_


```{r groupby, message=F, warning=F}
library(dplyr)
grouped_data_spine = group_by( data_spine, Class.attribute)
```
Note that you have to group using a discrete valued variable (factor, character, integer)


## Grouped summaries
```{r, eval=F}
summarize(grouped_data_spine, 
          mean(Pelvic.incidence), 
          sd(Pelvic.incidence),
          min(Pelvic.incidence),
          max(Pelvic.incidence))
```
```{r, echo=F}
knitr::kable(summarise(grouped_data_spine,
          mean(Pelvic.incidence), 
          sd(Pelvic.incidence),
          min(Pelvic.incidence),
          max(Pelvic.incidence)))
```

## Grouped summaries
```{r, eval=F}
summarize(grouped_data_spine, 
          Mean = mean(Pelvic.incidence), 
          SD = sd(Pelvic.incidence),
          Min = min(Pelvic.incidence),
          Max = max(Pelvic.incidence))
```
```{r, echo=F}
knitr::kable(summarize(grouped_data_spine, 
          Mean = mean(Pelvic.incidence), 
          SD = sd(Pelvic.incidence),
          Min = min(Pelvic.incidence),
          Max = max(Pelvic.incidence)))

```

## Grouped summaries

```{r}
summarize_all(grouped_data_spine, mean)
```

## A note on tibbles

+ Tibbles are a new-generation object meant to enhance the `data.frame`.
  + Central to the so-called [__tidyverse__ packages](http://www.tidyverse.org)
+ If you want to just get back to a more familiar `data.frame` object, use `as.data.frame`
+ A tibble is built on a `data.frame`, so all operations on `data.frame`'s will work.
+ To see all columns, set `options(dplyr.width=Inf)`.

Differences between a tibble and a `data.frame`:

1. Printing a tibble is restricted to the first 10 lines, and includes column types
2. Stricter subsetting rules that make the types of objects created consistent


# Grouped visualization

## Density plot
```{r, fig.width=6}
ggplot(data_spine, aes(x = Sacral.slope, group = Class.attribute, color=Class.attribute))+
  geom_density()
```

## Scatter plot
```{r, fig.width=6}
ggplot(data_spine, aes(x = Lumbar.lordosis.angle, y = Sacral.slope,
                       group = Class.attribute, color = Class.attribute))+
  geom_point()
```

## Scatter plot (Black and White)

```{r}
ggplot(data_spine, aes(x = Lumbar.lordosis.angle, y = Sacral.slope, 
                       group = Class.attribute, shape = Class.attribute))+
  geom_point()
```


## Scatter plot with size representing third variable

```{r}
ggplot(data_spine, aes(x = Lumbar.lordosis.angle, y = Sacral.slope))+
  geom_point(aes(size = Pelvic.slope))
```

## Scatter plot combinations

```{r}
ggplot(data_spine, aes(x = Lumbar.lordosis.angle, y = Sacral.slope, 
                       group = Class.attribute, color = Class.attribute))+
  geom_point(aes(size = Pelvic.slope))

```


## Scatter plot with lines
```{r , fig.width=6}
ggplot(data_spine, aes(x = Lumbar.lordosis.angle, y = Sacral.slope, 
                       group = Class.attribute, color=Class.attribute))+
  geom_point()+
  geom_smooth(method='lm')
```

## Scatter plot with lines
```{r , fig.width=6}
ggplot(data_spine, aes(x = Lumbar.lordosis.angle, y = Sacral.slope))+
  geom_point()+
  geom_smooth(aes(color = Class.attribute), method='lm')

```

# Facetting

## Facetting

Facetted graphs are a panel of graphs, each of which corresponds to a particular 
subgroup of the data. 

## Facetted scatter plot
```{r , fig.width=8}
ggplot(data_spine, aes(x = Lumbar.lordosis.angle, y = Sacral.slope))+
  geom_point()+
  facet_wrap( ~ Class.attribute, nrow=1)
```

## Facetted scatter plot with lines
```{r , fig.width=8}
ggplot(data_spine, aes(x = Lumbar.lordosis.angle, y = Sacral.slope))+
  geom_point()+ geom_smooth(method='lm')+
  facet_wrap( ~ Class.attribute, nrow=1)
```

# Manhattan plot

## Manhattan plot
```{r manhattan, fig.width=8, message=F, warning=F}
library(qqman)
data(gwasResults)
head(gwasResults)
```
```{r }
gwasResults = transform(gwasResults, x_position = 1:nrow(gwasResults))
```

## Manhattan plot
```{r , fig.width=8}
ggplot(gwasResults, aes(x = x_position, y = -log(P, base=10)))+
  geom_point(size=0.2)
```

## Manhattan plot
```{r , fig.width=8}
ggplot(gwasResults, aes(x = x_position, y = -log(P, base=10),
                        group=CHR, color=CHR))+
  geom_point(size=0.2)
```

## Manhattan plot
```{r , fig.width=8}
ggplot(gwasResults, aes(x = x_position, y = -log(P, base=10),
                        group=factor(CHR), color=factor(CHR)))+
  geom_point(size=0.2)
```

## Manhattan plot
```{r , fig.width=8}
ggplot(gwasResults, aes(x = x_position, y = -log(P, base=10),
                        group=factor(CHR), color=factor(CHR)))+
  geom_point(size=0.2)+
  geom_hline(yintercept = 8, color='red', linetype=2)
```

## Manhattan plot, exploded
```{r exploded, fig.width=8}
ggplot(gwasResults, aes(x = BP, y = -log(P, base=10)))+
  geom_point(size=0.2)+
  facet_wrap(~ CHR, nrow=4)+
  geom_hline(yintercept = 8, color='red', linetype=2)
```

## Manhattan plot, exploded
```{r exploded1, fig.width=8, echo=F}
ggplot(gwasResults, aes(x = BP, y = -log(P, base=10)))+
  geom_point(size=0.2)+
  facet_wrap(~ CHR, nrow=4)+
  geom_hline(yintercept = 8, color='red', linetype=2)
```