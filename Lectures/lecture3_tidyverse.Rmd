---
title: "The Tidyverse"
author: "BIOF 339"
date: "9/25/2018"
output: ioslides_presentation
css: style1.css
---

## What is the ["Tidyverse"](http://www.tidyverse.org)?



<div style="display:flex;align-items:center;font-size:30pt;font-family:serif;width:100%;height:300px;background-color:wheat;text-align:center; border: 1px solid red; position: relative;">

> The tidyverse is an opinionated collection of R packages designed for data science. All packages share an underlying design philosophy, grammar, and data structures

</div>

## What is the ["Tidyverse"](http://www.tidyverse.org)?

A set of R packages that:

<div style="font-size:20pt; font-family:serif;
width:100%; height:100px; padding-top: 20px; margin-bottom: 100px; background-color:wheat; border: 1px solid red; position: relative;">
<ul>
  <li> help make data more computer-friendly
  <li>while making your code more human-friendly
</ul>
</div>

- Most of these packages are (co-)written by Dr. Hadley Wickham, who has rockstar status in the R world
- They are supported by the company RStudio

# Tidying data

## Tidy data

<div style="display:flex;align-items:center;font-size:30pt;font-family:serif;width:100%;height:300px;background-color:wheat;text-align:center; padding-left:30px;border: 1px solid red; position: relative;">

> Tidy datasets are all alike, <br/>
but every messy data is messy in its own way

</div>

## Tidy data

Tidy data is a **computer-friendly** format based on the following characteristics:

+ Each row is one observation
- Each column is one variable
- Each set of observational unit forms a table

All other forms of data can be considered **messy data**.

## Let us count the ways

There are many ways data can be messy. An incomplete list....

+ Column headers are values, not variables
+ Multiple variables are stored in a single column
+ Variables are stored in both rows and columns
+ Multiple types of observational units are saved in the same table
+ A single observational unit is stored in multiple tables

## Ways to have messy (i.e. not tidy) data

1. Column headers contain values

Country   |   < $10K    | $10-20K    | $20-50K   | $50-100K    | > $100K
----------|-------------|------------|-----------|-------------|---------
India     |   40        |  25        |   25      |  9          |  1
USA       |   20        |  20        |  20       | 30          |  10

## Ways to have messy (i.e. not tidy) data

1. Column headers contain values

Country   |   Income  | Percentage
----------|-----------|------------
India     |  < $10K   |  40
USA       |  < $10K   | 20

This is a case of reshaping or melting 

## Ways to have messy (i.e. not tidy) data

2. Multiple variables in one column

Country  | Year   | M_0-14  | F_0-14  | M_ 15-60  | F_15-60  | M_60+  | F_60+
---------|--------|---------|---------|-----------|----------|--------|-------
UK       |  2010  |         |         |           |          |        | 
UK       |  2011  |         |         |           |          |        | 

<p>

Country  | Year   | Gender  | Age    | Count
---------|--------|---------|--------|-------


Separating columns into different variables

## Tidying data

The typical steps are 

+ Transforming data from wide to tall (*gather*) and from tall to wide (*spread*)
+ Separating columns into different columns
+ Putting columns together into new variables


# Cleaning data

## Some actions on data

+ Creating new variables (*mutate*)
+ Choose some columns (*select*)
+ Selecting rows based on some criteria (*filter*)
+ Sort data based on some variables (*arrange*)

## Example data

```{r}
data(mtcars)
knitr::kable(head(mtcars, 3))
```

+ Car names are in an attribute of the data.frame called `rownames`. So it's not in a column
+ We might want to convert fuel economy to metric 
+ We might just want to look at the relationship between displacement and fuel economy based on number of cylinders

## Example data ([link](https://dl.dropboxusercontent.com/s/pqavhcckshqxtjm/brca.csv))

```{r}
link <- 'https://dl.dropboxusercontent.com/s/pqavhcckshqxtjm/brca.csv'
download.file(link, 'brca.csv')
brca_data <- read.csv('brca.csv', stringsAsFactors=FALSE)
```
<img src = "https://dl.dropboxusercontent.com/s/k3r12s7d22zhku8/Screenshot%202018-09-26%2000.27.50.png" 
  width="600" height="150"></img>

## The `tidyverse` package

The `tidyverse` package is a meta-package that installs a set of packages that are useful for data 
cleaning, data tidying and data munging (manipulating data to get a computationally "attractive" 
dataset)

## The `tidyverse` package

```{r, warning=FALSE}
# install.packages('tidyverse')
library(tidyverse)
```

<div style = "border: 2px solid red;padding: 20px; width: 85%;">

> You can specify a function from a particular package as `dplyr::filter`. Note there
are two colons there

</div>

## Core `tidyverse` packages

```{r, echo = FALSE, message=F, warning=F}
my_tbl <- tibble::tribble(
  ~Package, ~Description,
      'ggplot2',     'Data visualization (next week)',
      'tibble',     'data.frame on steroids',
      'tidyr',     'Data tidying (today)',
      'readr',     'Reading text files (CSV)',
      'purrr',     'Applying functions to data iteratively(later this sem)',
      'dplyr',     'Data cleaning and munging (today)',
      'stringr',     'String (character) manipulation',
      'forcats',     'Manipulating categorical variables'
  )

require(knitr)
kable(my_tbl, digits = 3, row.names = FALSE, align = "l",
              caption = NULL)
```

## Additional `tidyverse` packages

```{r, echo=F}
my_tbl <- tibble::tribble(
  ~Package, ~Description,
      'readxl',     'Read Excel files',
      'haven',     'Read SAS, SPSS, Stata files',
      'lubridate',  'Deal with dates and times'  ,
      'magrittr',     'Provides the pipe operator %>%',
      'glue', 'Makes pasting text and data easier')

require(knitr)
kable(my_tbl, digits = 3, row.names = FALSE, align = "c",
              caption = NULL)

```

# Pipes

## A pipe example (data munging)

```{r, message=F, warning=F}
library(tidyverse)
updated_cars <- 
  mtcars %>% 
  rownames_to_column(var = 'Model') %>% 
  mutate(kmpg = mpg * 1.6) %>% 
  select(Model, kmpg, cyl, disp) %>% 
  filter(cyl == 6)
```
```{r, echo=F}
knitr::kable(head(updated_cars), format='pandoc')
```

## A pipe example (data munging)

```{r, message=F, warning=F}
library(tidyverse)
updated_cars <- 
  mtcars %>% # Take the data set
  rownames_to_column(var = 'Model') %>% # Make rownames a column
  select(Model, mpg, cyl, disp) %>% # Keep only certain columns
  mutate(kmpg = mpg * 1.6) %>% # Create a new variable
  filter(cyl == 6) # Keep only certain rows
```

The idea is to use **verbs** to express operations on a dataset, so it is easier to express what you want to do in code. 

## The pipe operator

The pipe operator `%>%` (technically from the package `magrittr`) takes a 
**data.frame or tibble object** on the left, then "pipes" it to a function that takes the **data.frame object as its first argument**.

```{r, eval=F}
mtcars %>% mutate(kmpg = mpg * 1.6)
```

would be the same as 

```{r, eval = F}
mutate(mtcars, kmpg = mpg * 1.6)
```

## The pipe operator


### With pipes

```{r, eval = F}
mtcars %>% 
  rownames_to_column(var = "Model") %>% 
  select(Model:disp) %>% 
  mutate(kmpg = mpg * 1.6) %>% 
  filter(cyl == 6)
```

### Without pipes

```{r, eval = F}
tmp <- rownames_to_column(mtcars, var="Model")
tmp3 <- select(tmp2, Model:disp)
tmp2 <- mutate(tmp, kmpg = mpg * 1.6)
tmp4 <- filter(tmp3, cyl == 6)
```

Both are fine, but I find pipes help translating my thoughts into code better

## The pipe operator

### With pipes + tidyverse

```{r, eval = F}
updated_cars <- mtcars %>% 
  rownames_to_column(var = "Model") %>% 
  select(Model:disp) %>% 
  mutate(kmpg = mpg * 1.6) %>% 
  filter(cyl == 6)
```

### Without tidyverse

```{r, eval = F}
mtcars[,'Model'] <- rownames(mtcars)
tmp <- mtcars[,c('Model','mpg','cyl','disp')] # Can't use the : operator for names
tmp[,'kmpg'] <- tmp[,'mpg'] * 1.6 # Note we need to quote the names
updated_cars <- tmp[tmp[,'cyl'] == 6,] 
```

Idea was to make it easier to write expressive code without getting too hung up with syntax. 

# Going through step by step

##

```{r, eval = F}
mtcars
```

<div style = "position: fixed; bottom: 0; height: 50%; ">

```{r, echo = F}
mtcars %>% head(3) %>% knitr::kable()
```

</div>

##

```{r, eval = F}
mtcars %>% 
  rownames_to_column(var = "Model")
```

<div style = "position: fixed; bottom: 0; height: 50%; ">

```{r, echo = F}
mtcars %>% rownames_to_column(var = "Model") %>% head(3) %>% knitr::kable()
```

</div>

##

```{r, eval = F}
mtcars %>% 
  rownames_to_column(var = "Model") %>% 
  select(Model:disp)
```

<div style = "position: fixed; bottom: 0; height: 50%; ">

```{r, echo = F}
mtcars %>% rownames_to_column(var = "Model") %>% 
  select(Model:disp) %>% 
  head(3) %>% knitr::kable()
```

</div>

##

```{r, eval = F}
mtcars %>% 
  rownames_to_column(var = "Model") %>% 
  select(Model:disp) %>% 
  mutate(kmpg = mpg * 1.6)
```

<div style = "position: fixed; bottom: 0; height: 50%; ">

```{r, echo = F}
mtcars %>% rownames_to_column(var = "Model") %>% 
  select(Model:disp) %>% 
  mutate(kmpg = mpg * 1.6) %>% 
  head(3) %>% knitr::kable()
```

</div>

##

```{r, eval = F}
mtcars %>% 
  rownames_to_column(var = "Model") %>% 
  select(Model:disp) %>% 
  mutate(kmpg = mpg * 1.6) %>% 
  filter(cyl == 6)
```

<div style = "position: fixed; bottom: 0; height: 50%; ">

```{r, echo = F}
mtcars %>% rownames_to_column(var = "Model") %>% 
  select(Model:disp) %>% 
  mutate(kmpg = mpg * 1.6) %>% 
  filter(cyl == 6) %>% 
  head(2) %>% knitr::kable()
```

</div>

# Data tidying

## 
```{r, eval = F}
link <- 'https://dl.dropboxusercontent.com/s/pqavhcckshqxtjm/brca.csv'
download.file(link, 'brca.csv')
brca_data <- read.csv('brca.csv', stringsAsFactors=FALSE)
```
<img src = "https://dl.dropboxusercontent.com/s/k3r12s7d22zhku8/Screenshot%202018-09-26%2000.27.50.png" 
  width="600" height="150"></img>

## 
```{r, message = F, warning = F}
library(tidyverse)
names(brca_data)
```

